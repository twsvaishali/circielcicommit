version: 2
jobs:
 version-prod:
    working_directory: /project/workspace/
    docker:
      - image: lakhanmandloi/docker-ubuntu-ruby-python-npm:2.0
    steps:

      # Checkout
      - checkout

      # Add SSH Key
      - add_ssh_keys:
          fingerprints:
            - "84:85:ac:eb:01:24:f5:cf:10:42:93:30:a3:c8:84:95"

      # Configure Git
      - type: shell
        name: Configure git
        command: |
          git config --global user.email vaishali_k@techjoomla.com
          git config --global user.name twsvaishali

      # Download code from staging
      - type: shell
        name: Download code from staging
        command: |
          cd ..
          rm -rf downloads
          mkdir downloads
          cd downloads
          ls -la

      # Deploy to Gitpages
      - type: shell
        name: Deploy code to gh-pages repo
        command: |
          cd ..
          rm -rf deploy
          mkdir deploy
          cd deploy
          echo $CIRCLE_REPOSITORY_URL
          echo $CIRCLE_BRANCH
           echo "buildNo: '"$CIRCLE_BUILD_NUM"'" >> _config.yml
          echo "docsBranch: '"$CIRCLE_BRANCH"'" >> _config.yml
          echo "docsVersion: '"$CIRCLE_BRANCH"'" >> _config.yml
          git clone -b gh-pages $CIRCLE_REPOSITORY_URL cloned-repo
          rm -rf cloned-repo/$CIRCLE_BRANCH/
          mkdir cloned-repo/$CIRCLE_BRANCH/
          cp -R ../downloads/* cloned-repo/$CIRCLE_BRANCH/
          cd cloned-repo/
          git add -A
          git commit -m "Version deploy - $CIRCLE_BRANCH Version & Build No. $CIRCLE_BUILD_NUM"
          git push origin gh-pages

workflows:
  version: 2
  version-build-deploy:
    jobs:
      - version-prod:
          filters:
            branches:
              ignore:
                - gh-pages
                - toc
                - /^pull.*/


